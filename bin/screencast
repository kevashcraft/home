#!/bin/bash
#
# record the screen with a webcam overlay
#

# filename with timestamp
screencap=kscreen-$(date -Iseconds).mkv

# record screen, webcam, and audio
ffmpeg \
  -f x11grab \ # screen grab
    -video_size 3840x2160 \
    -i :0.0 \
  -f v4l2 \ # webcam grab
    -framerate 30 \
    -i /dev/video0 \
  -f alsa \ # audio grab
    -ac 2 \
    -itsoffset 0.4 \ # offset audio to align with video
    -i pulse \
  -filter_complex \ # overlay webcam in top right
    "[0:v]setpts=PTS-STARTPTS[bg]; \
     [1:v]setpts=PTS-STARTPTS[fg]; \
     [bg][fg]overlay=W-w-10:10,format=yuv420p[out]" \
  -map "[out]" \
  -map 2:a \
  -c:v libx264 \ # convert to x.264 (fastest method)
    -preset veryfast \
    -g 30 \ # ensure 1 keyframe/second
  -c:a aac \
    -b:a 160k \
    -ar 44100 \
  /home/kevin/Documents/screencaps/$screencap

# auto open vlc
if [ $vlc="true"]; do
  vlc /home/kevin/Documents/screencaps/$screencap
done
